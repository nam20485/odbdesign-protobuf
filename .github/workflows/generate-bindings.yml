name: Generate Protobuf SDKs

on:
  push:
    paths:
      - 'protoc/**'
      - 'scripts/generate_protos.sh'
      - '.github/workflows/generate-bindings.yml'
  pull_request:
    paths:
      - 'protoc/**'
      - 'scripts/generate_protos.sh'
      - '.github/workflows/generate-bindings.yml'
  workflow_dispatch:

jobs:
  codegen:
    name: Build language outputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install protoc and gRPC C++ plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler protobuf-compiler-grpc unzip curl

      - name: Install gRPC C# plugin
        env:
          GRPC_VERSION: '1.63.0'
        run: |
          curl -sSL "https://github.com/grpc/grpc/releases/download/v${GRPC_VERSION}/grpc_csharp_plugin-v${GRPC_VERSION}-linux-x64.zip" -o /tmp/grpc_csharp_plugin.zip
          unzip -o /tmp/grpc_csharp_plugin.zip -d /tmp/grpc_csharp_plugin
          sudo mv /tmp/grpc_csharp_plugin/grpc_csharp_plugin /usr/local/bin/grpc_csharp_plugin
          sudo chmod +x /usr/local/bin/grpc_csharp_plugin
          rm -rf /tmp/grpc_csharp_plugin /tmp/grpc_csharp_plugin.zip

      - name: Make generator executable
        run: chmod +x scripts/generate_protos.sh

      - name: Generate bindings
        run: bash scripts/generate_protos.sh

      - name: Upload C++ artifact
        uses: actions/upload-artifact@v4
        with:
          name: protobuf-cpp
          path: generated/cpp

      - name: Upload C# artifact
        uses: actions/upload-artifact@v4
        with:
          name: protobuf-csharp
          path: generated/csharp
