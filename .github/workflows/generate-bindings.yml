name: Generate Protobuf SDKs

on:
    push:
        paths:
            - "protoc/**"
            - "scripts/generate_protos.sh"
            - ".github/workflows/generate-bindings.yml"
            - "src/**"
            - "cpp/native/**"
    pull_request:
        paths:
            - "protoc/**"
            - "scripts/generate_protos.sh"
            - ".github/workflows/generate-bindings.yml"
            - "src/**"
            - "cpp/native/**"
    workflow_dispatch:

jobs:
    codegen:
        permissions:
            contents: read
            packages: write
        name: Build language outputs
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up .NET SDK
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "8.0.x"

            - name: Set up CMake
              uses: jwlawson/actions-setup-cmake@v1.14
              with:
                  cmake-version: "3.27"

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential cmake git unzip curl

            - name: Build protoc and gRPC C++ plugin from source
              run: |
                  mkdir -p build-tools
                  cd build-tools
                  cmake -S ../cpp/tools -B . \
                      -DCMAKE_BUILD_TYPE=Release
                  
                  # Build all dependencies first (this will build protobuf and gRPC)
                  # Then build the specific tools we need
                  echo "Building protoc and grpc_cpp_plugin..."
                  
                  # Try to build protoc target (may be named differently)
                  if cmake --build . --target protoc 2>/dev/null; then
                      echo "Built protoc target"
                  else
                      echo "protoc target not found, will search for executable"
                  fi
                  
                  # Try to build grpc_cpp_plugin
                  if cmake --build . --target grpc_cpp_plugin 2>/dev/null; then
                      echo "Built grpc_cpp_plugin target"
                  else
                      echo "grpc_cpp_plugin target not found, will search for executable"
                  fi
                  
                  # Build everything to ensure all dependencies are built
                  cmake --build . --parallel $(nproc)
                  
                  # Find protoc - it's built as part of protobuf (gRPC dependency)
                  # protoc may be named with a version suffix (e.g., protoc-27.2.0)
                  echo "Searching for protoc..."
                  # Search in protobuf build directory - protoc is typically at _deps/grpc-build/third_party/protobuf/protoc*
                  PROTOC_PATH=$(find . -path "*/protobuf/protoc*" -type f -executable 2>/dev/null | head -1)
                  
                  # If not found, try broader search
                  if [ -z "$PROTOC_PATH" ]; then
                      PROTOC_PATH=$(find . -name "protoc*" -type f -executable 2>/dev/null | grep -vE "\.(cmake|sh|rb|md)$" | head -1)
                  fi
                  
                  # Find grpc_cpp_plugin
                  echo "Searching for grpc_cpp_plugin..."
                  GRPC_CPP_PLUGIN_PATH=$(find . -name "grpc_cpp_plugin" -type f -executable 2>/dev/null | head -1)
                  
                  if [ -z "$PROTOC_PATH" ]; then
                      echo "Error: Could not find protoc in build directory"
                      echo "Build tree structure:"
                      find . -type d -maxdepth 3 | head -30
                      echo "All executables found:"
                      find . -type f -executable 2>/dev/null | head -20
                      exit 1
                  fi
                  
                  if [ -z "$GRPC_CPP_PLUGIN_PATH" ]; then
                      echo "Error: Could not find grpc_cpp_plugin in build directory"
                      echo "Build tree structure:"
                      find . -type d -maxdepth 3 | head -30
                      echo "All executables found:"
                      find . -type f -executable 2>/dev/null | head -20
                      exit 1
                  fi
                  
                  echo "Found protoc at: $PROTOC_PATH"
                  echo "Found grpc_cpp_plugin at: $GRPC_CPP_PLUGIN_PATH"
                  
                  # Find protobuf well-known types include path
                  # These are in the gRPC source tree under third_party/protobuf/src
                  echo "Searching for protobuf well-known types..."
                  PROTOBUF_INCLUDE_PATH=$(find . -path "*grpc-src/third_party/protobuf/src" -type d 2>/dev/null | head -1)
                  if [ -z "$PROTOBUF_INCLUDE_PATH" ]; then
                      # Try alternate paths
                      PROTOBUF_INCLUDE_PATH=$(find . -path "*/protobuf/src/google/protobuf/timestamp.proto" -type f 2>/dev/null | head -1 | sed 's|/google/protobuf/timestamp.proto||')
                  fi
                  
                  if [ -z "$PROTOBUF_INCLUDE_PATH" ]; then
                      echo "Error: Could not find protobuf well-known types directory"
                      echo "Searching for timestamp.proto:"
                      find . -name "timestamp.proto" 2>/dev/null | head -10
                      exit 1
                  fi
                  
                  # Convert to absolute path
                  PROTOBUF_INCLUDE_PATH=$(cd "$PROTOBUF_INCLUDE_PATH" && pwd)
                  echo "Found protobuf include path at: $PROTOBUF_INCLUDE_PATH"
                  
                  # Create tools directory and copy binaries
                  mkdir -p "$GITHUB_WORKSPACE/tools/bin"
                  cp "$PROTOC_PATH" "$GITHUB_WORKSPACE/tools/bin/protoc"
                  cp "$GRPC_CPP_PLUGIN_PATH" "$GITHUB_WORKSPACE/tools/bin/grpc_cpp_plugin"
                  chmod +x "$GITHUB_WORKSPACE/tools/bin/protoc"
                  chmod +x "$GITHUB_WORKSPACE/tools/bin/grpc_cpp_plugin"
                  
                  echo "$GITHUB_WORKSPACE/tools/bin" >> $GITHUB_PATH
                  
                  # Export protobuf include path for generate script
                  echo "PROTOBUF_INCLUDE_PATH=$PROTOBUF_INCLUDE_PATH" >> $GITHUB_ENV

            - name: Install gRPC C# plugin
              env:
                  GRPC_TOOLS_VERSION: "2.65.0"
              run: |
                  TMP_DIR="$(mktemp -d)"
                  NUGET_PACKAGE_URL="https://www.nuget.org/api/v2/package/Grpc.Tools/${GRPC_TOOLS_VERSION}"
                  curl -sSL "$NUGET_PACKAGE_URL" -o "$TMP_DIR/grpc.tools.nupkg"
                  unzip -q "$TMP_DIR/grpc.tools.nupkg" "tools/linux_x64/grpc_csharp_plugin" -d "$TMP_DIR"
                  mkdir -p "$GITHUB_WORKSPACE/tools/bin"
                  cp "$TMP_DIR/tools/linux_x64/grpc_csharp_plugin" "$GITHUB_WORKSPACE/tools/bin/grpc_csharp_plugin"
                  chmod +x "$GITHUB_WORKSPACE/tools/bin/grpc_csharp_plugin"
                  rm -rf "$TMP_DIR"

            - name: Verify tools are available
              run: |
                  which protoc
                  which grpc_cpp_plugin
                  which grpc_csharp_plugin
                  protoc --version
                  grpc_cpp_plugin --version || echo "grpc_cpp_plugin version check (may not support --version)"

            - name: Make generator executable
              run: chmod +x scripts/generate_protos.sh

            - name: Generate bindings
              run: bash scripts/generate_protos.sh

            - name: Determine package version
              id: version
              run: |
                  VERSION="0.1.${GITHUB_RUN_NUMBER}"
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"

            - name: Configure GitHub Packages source
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  dotnet nuget add source \
                      --username "$GITHUB_ACTOR" \
                      --password "$GITHUB_TOKEN" \
                      --store-password-in-clear-text \
                      --name github \
                      "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"

            - name: Create artifacts directory
              run: mkdir -p artifacts/nuget

            - name: Pack NuGet package
              run: dotnet pack src/dotnet/OdbDesign.Protobuf/OdbDesign.Protobuf.csproj -c Release -o artifacts/nuget /p:PackageVersion=${{ steps.version.outputs.version }}

            - name: Publish NuGet package
              env:
                  NUGET_API_KEY: ${{ secrets.GITHUB_TOKEN }}
              run: dotnet nuget push artifacts/nuget/*.nupkg --source github --api-key "$NUGET_API_KEY" --skip-duplicate

            - name: Upload C++ artifact
              uses: actions/upload-artifact@v4
              with:
                  name: protobuf-cpp
                  path: generated/cpp

            - name: Upload C# artifact
              uses: actions/upload-artifact@v4
              with:
                  name: protobuf-csharp
                  path: generated/csharp

    native-libs:
        name: Native shared libs (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        needs: codegen
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download generated C++ code
              uses: actions/download-artifact@v4
              with:
                  name: protobuf-cpp
                  path: generated/cpp

            - name: Set up CMake
              uses: jwlawson/actions-setup-cmake@v1.14
              with:
                  cmake-version: "3.27"

            - name: Configure CMake
              shell: bash
              run: |
                  cmake -S cpp/native -B build \
                      -DCMAKE_BUILD_TYPE=Release \
                      -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/artifacts/native/${{ matrix.os }}"

            - name: Build native library
              shell: bash
              run: cmake --build build --config Release --target install

            - name: Upload shared library
              uses: actions/upload-artifact@v4
              with:
                  name: native-${{ matrix.os }}
                  path: artifacts/native/${{ matrix.os }}
